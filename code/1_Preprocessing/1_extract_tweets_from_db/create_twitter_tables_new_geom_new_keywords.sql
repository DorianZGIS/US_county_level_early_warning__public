-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- This file shows the steps which were performed to create the covid19 tweets table on the database level
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Structure:

-- 1. Filter out tweets in the spatial and temporal dimensions  
-- 2. Filter for keywords
-- 3. Add county level geometries to the tweets
----------- 3.1. Add county id
----------- 3.2. Aggregate on county, date and corona_related
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------



-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 1. First create tables
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 2020
create table covid.tweets_2020 TABLESPACE extern_hard_disc as (
SELECT message_id, date, text, place, geom, retweets, user_id, followers, latitude, longitude 
	FROM archive.twitter 
	WHERE date > '2019-12-31'
	AND date < '2021-01-01'
	AND  ST_Contains(ST_Geomfromtext('POLYGON((-94.29626464843747 48.82253520412155,-89.33166503906247 48.086482939580165,-88.40454101562496 48.49930883702451,-81.82617187499996 45.556997304202724,-82.12738037109368 43.58413037683304,-82.40661621093744 42.019577581169486,-78.82598876953122 43.62158420926344,-75.15747070312496 45.10452321662082,-72.00256347656244 45.19416468029458,-69.63409423828121 47.58653720888464,-67.26562499999997 47.3621620334887,-66.42333984375 44.98354963777504,-73.8427734375 33.684946574921526,-76.19628906250003 26.48320357120556,-80.57128906250001 23.63324079406921,-97.66601562499999 25.36728759218286,-103.24707031250001 28.939007844711835,-116.58447265625003 31.32803288903339,-124.64843750000001 33.584746186613586,-128.35937499999997 49.243899719809306,-95.37017822265624 49.06606565614926,-95.24520874023436 49.4362797026685,-94.79820251464842 49.42779507018419,-94.60765838623045 48.956849452333515,-94.29626464843747 48.82253520412155))',4326), ST_Centroid(geom))
)

-- 2021
create table covid.tweets_2021 TABLESPACE extern_hard_disc as (
SELECT message_id, date, text, place, geom, retweets, user_id, followers, latitude, longitude 
	FROM archive.twitter 
	WHERE date > '2020-12-31'
	AND date < '2022-01-01'
	AND  ST_Contains(ST_Geomfromtext('POLYGON((-94.29626464843747 48.82253520412155,-89.33166503906247 48.086482939580165,-88.40454101562496 48.49930883702451,-81.82617187499996 45.556997304202724,-82.12738037109368 43.58413037683304,-82.40661621093744 42.019577581169486,-78.82598876953122 43.62158420926344,-75.15747070312496 45.10452321662082,-72.00256347656244 45.19416468029458,-69.63409423828121 47.58653720888464,-67.26562499999997 47.3621620334887,-66.42333984375 44.98354963777504,-73.8427734375 33.684946574921526,-76.19628906250003 26.48320357120556,-80.57128906250001 23.63324079406921,-97.66601562499999 25.36728759218286,-103.24707031250001 28.939007844711835,-116.58447265625003 31.32803288903339,-124.64843750000001 33.584746186613586,-128.35937499999997 49.243899719809306,-95.37017822265624 49.06606565614926,-95.24520874023436 49.4362797026685,-94.79820251464842 49.42779507018419,-94.60765838623045 48.956849452333515,-94.29626464843747 48.82253520412155))',4326), ST_Centroid(geom))
) 

-- 2022
create table covid.tweets_2022 TABLESPACE extern_hard_disc as (
SELECT message_id, date, text, place, geom, retweets, user_id, followers, latitude, longitude 
	FROM archive.twitter 
	WHERE date > '2021-12-31'
	AND date < '2023-01-01'
	AND  ST_Contains(ST_Geomfromtext('POLYGON((-94.29626464843747 48.82253520412155,-89.33166503906247 48.086482939580165,-88.40454101562496 48.49930883702451,-81.82617187499996 45.556997304202724,-82.12738037109368 43.58413037683304,-82.40661621093744 42.019577581169486,-78.82598876953122 43.62158420926344,-75.15747070312496 45.10452321662082,-72.00256347656244 45.19416468029458,-69.63409423828121 47.58653720888464,-67.26562499999997 47.3621620334887,-66.42333984375 44.98354963777504,-73.8427734375 33.684946574921526,-76.19628906250003 26.48320357120556,-80.57128906250001 23.63324079406921,-97.66601562499999 25.36728759218286,-103.24707031250001 28.939007844711835,-116.58447265625003 31.32803288903339,-124.64843750000001 33.584746186613586,-128.35937499999997 49.243899719809306,-95.37017822265624 49.06606565614926,-95.24520874023436 49.4362797026685,-94.79820251464842 49.42779507018419,-94.60765838623045 48.956849452333515,-94.29626464843747 48.82253520412155))',4326), ST_Centroid(geom))
) 

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 2. Filter for keywords
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

---- Add keyword columns

-- 2020
ALTER TABLE covid.tweets_2020 ADD COLUMN keywords_covid_baseline_topic bigint default 0;
UPDATE covid.tweets_2020
SET keywords_covid_baseline_topic = 1
WHERE lower(text) similar to lower('%(covid|corona|sarscov|sars-cov|epidemic|pandemic|influenza|virus|viral|infect|2019-ncov|Delta variant|Omicron|H1N1|H3N2|Wuhan|Chinese virus|transmission|super spread|incubation|quarantine|lockdown|vaccin|fever|cough|headache|fatigue|body aches|loss of taste|loss of smell|loss of taste|no smell|no taste|respirator|face mask|masks)%');

-- 2021
ALTER TABLE covid.tweets_2021 ADD COLUMN keywords_covid_baseline_topic bigint default 0;
UPDATE covid.tweets_2021
SET keywords_covid_baseline_topic = 1
WHERE lower(text) similar to lower('%(covid|corona|sarscov|sars-cov|epidemic|pandemic|influenza|virus|viral|infect|2019-ncov|Delta variant|Omicron|H1N1|H3N2|Wuhan|Chinese virus|transmission|super spread|incubation|quarantine|lockdown|vaccin|fever|cough|headache|fatigue|body aches|loss of taste|loss of smell|loss of taste|no smell|no taste|respirator|face mask|masks)%');

-- 2022
ALTER TABLE covid.tweets_2022 ADD COLUMN keywords_covid_baseline_topic bigint default 0;
UPDATE covid.tweets_2022
SET keywords_covid_baseline_topic = 1
WHERE lower(text) similar to lower('%(covid|corona|sarscov|sars-cov|epidemic|pandemic|influenza|virus|viral|infect|2019-ncov|Delta variant|Omicron|H1N1|H3N2|Wuhan|Chinese virus|transmission|super spread|incubation|quarantine|lockdown|vaccin|fever|cough|headache|fatigue|body aches|loss of taste|loss of smell|loss of taste|no smell|no taste|respirator|face mask|masks)%');

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 3. Add county level geometries to the tweets
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 3.1 Add county id
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

---- add county_id_new column
ALTER TABLE
covid.tweets_2020
ADD COLUMN county_id_new integer;

ALTER TABLE
covid.tweets_2021
ADD COLUMN county_id_new integer;

ALTER TABLE
covid.tweets_2022
ADD COLUMN county_id_new integer;


---- add geometry index
create index idx_spatial_2020 on covid.tweets_2020 using GIST(geom)

create index idx_spatial_2021 on covid.tweets_2021 using GIST(geom)

create index idx_spatial_2022 on covid.tweets_2022 using GIST(geom)

---- match county geometry centroids with county geometries
UPDATE covid.tweets_2020 tw
SET county_id_new = ol.id
from covid.county as ol
WHERE
st_within (tw.geom, ol.geom);

UPDATE covid.tweets_2021 tw
SET county_id_new = ol.id
from covid.county as ol
WHERE
st_within (tw.geom, ol.geom); 

UPDATE covid.tweets_2022 tw
SET county_id_new = ol.id
from covid.county as ol
WHERE
st_within (tw.geom, ol.geom); 

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- 3.2 Aggregate on county, date and corona_related
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

---- Build table with aggregations of tweets per keyword list for each county
-- 2020
create table covid.tweets_2020_agg_county as (
	select (to_char(date, 'YYYY-MM-DD'::text)) as date, county_id_new, count(*) as all_tweets,
	sum(keywords_covid_baseline_topic) as keywords_covid_baseline_topic
	from covid.tweets_2020
	GROUP BY (to_char(date, 'YYYY-MM-DD'::text)), county_id_new 
)

-- 2021
create table covid.tweets_2021_agg_county as (
	select (to_char(date, 'YYYY-MM-DD'::text)) as date, county_id_new, count(*) as all_tweets,
	sum(keywords_covid_baseline_topic) as keywords_covid_baseline_topic
	from covid.tweets_2021
	GROUP BY (to_char(date, 'YYYY-MM-DD'::text)), county_id_new 
) 

-- 2022
create table covid.tweets_2022_agg_county as (
	select (to_char(date, 'YYYY-MM-DD'::text)) as date, county_id_new, count(*) as all_tweets,
	sum(keywords_covid_baseline_topic) as keywords_covid_baseline_topic
	from covid.tweets_2022
	GROUP BY (to_char(date, 'YYYY-MM-DD'::text)), county_id_new 
)

